---
layout: post
title: "HowTo: Getting started with JUnit testing for Liferay portlets with Netbeans (for Eclipse users)"
date: 2009-06-10
comments: true
tags: [  HowTo, Java, testing, Web dev ]
---

Besides at work, where I'm developing in .Net using Visual Studio, I'm a heavy <a href="http://www.eclipse.org/">Eclipse</a> user. I use it for a lot of things, programming <a href="http://blog.js-development.com/2009/02/getting-ready-for-mobile-development.html">J2ME</a>, J2EE, when developing Java desktop clients (using <a href="http://blog.js-development.com/search/label/RCP">Eclipse RCP</a>) or even when writing <a href="http://blog.js-development.com/2009/03/floating-figures-and-tables-with-latex.html">LaTeX</a> documents. With its dozens of plugins it provides a very handy environment. This semester however, I switched to using Netbeans for my <a href="http://projects.js-development.com/lifepin">project for the Advanced Web Programming course</a>, mainly because Netbeans was the professor's choice. Anyway, it may never be bad to see some other environments too :)<br /><br /><span style="font-size: large;">Basic portlet project setup</span><br /><br />But let's switch to the topic of this post. What I want to address in this post here is to give some instructions/hints on how to setup the environment for writing JUnit tests. The setup and configuration is mainly targeted to the project structure of Liferay portlets which are created as Free form projects in Netbeans. So first lets take a look at the project structure of the portlet project. The folders are arranged as follows:<br /><ul><li><project name=""></project></li> <li>docroot</li><ul><li>WEB-INF</li><ul><li>classes <span style="font-size: x-small;">(output for compiled java files)</span></li><li> jsp</li><li>lib <span style="font-size: x-small;">(contains all of the jar libraries that are being used)</span></li><li>src</li><li>tld</li><li><i>portlet.xml </i><br /></li><li><i>web.xml</i><br /></li><ul></ul></ul><li> css</li><li>...</li><ul></ul></ul><li>nbproject (created by netbeans when you import the project)</li><li><i>build.xml </i><br /></li><ul></ul></ul>So to not mix test cases with the source code that is compiled and deployed on the portal server, I decided to modify the structure like this<br /><br /><ul><li><project name=""></project></li> <li>docroot</li><ul><li>WEB-INF</li><ul><li>classes <span style="font-size: x-small;">(output for compiled java files)</span></li><li> jsp</li><li>lib <span style="font-size: x-small;">(contains all of the jar libraries that are being used)</span></li><li>src</li><li>tld</li><li><i>portlet.xml </i><br /></li><li><i>web.xml</i><br /></li><ul></ul></ul><li> css</li><li>...</li><ul></ul></ul><li>nbproject (created by netbeans when you import the project)</li><li>unitTests</li><ul><li> lib</li><li>output<br /></li><li>src</li><ul><li>(package structure: com/..../....)<br /></li><ul></ul></ul></ul><li><i>build.xml </i></li></ul>Just some brief explanation on the choice of my folders (note, there may be better arrangements):<br /><ul><li><b>lib</b><br />You may wonder why I created another "lib" folder, since I already have the one in the WEB-INF folder. Well that's because I thought it may be useful to do so, since there may be libraries specific to the unit testing as for instance mock libraries or the JUnit library itself.<br />Note however that your unit tests may also need the libraries from your WEB-INF/lib folder because you use of course classes from the WEB-INF/src folder which are the objects for your test cases. The libraries are however not copied, but just referenced in the classpath of your Ant scripts (we will see later)<br /><br /></li><li><b>output</b><br />This folder contains the compiled test cases from the "unitTests/src" folder. Moreover it also needs to contain the compiled java src files from the WEB-INF/classes folder because you reference these objects in your test case (you actually test them there ;) )<br /><br /></li><li><b>src</b><br />Finally, this folder contains the java packages containing your unit tests. I recommend names such as "<com|org>.<yourprojectname>.<unittests>.<projectpackageyoutest>" and the test case name.<br />So, if you have a class MyService in the <i>com.lifepin.services</i> package and you create a test case, you would create an according package <i>com.lifepin.unittests.services</i> (in your unitTest folder) where you would put your MyServiceTest test case. (this is just a recommendation)</projectpackageyoutest></unittests></yourprojectname></com|org></li></ul>Let's go on. To acutally use your unitTests folder, you have to declare it as a source folder, actually more specific as a "Test package folder" (right-click on the project + Properties). Note this is specific to Netbeans and doesn't exist in Eclipse which makes no distinctions between test folders and normal src folders.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/_tF6XjsUy87k/SdxKGZDsNAI/AAAAAAAACMs/w-HaPeN6nbA/s1600-h/ProjectPropertiesLifePinUnitTests.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://4.bp.blogspot.com/_tF6XjsUy87k/SdxKGZDsNAI/AAAAAAAACMs/w-HaPeN6nbA/s400/ProjectPropertiesLifePinUnitTests.png" /></a></div><br />If you accidentally declare your unitTests folder as source folder you'll get the error message "No test root folder was found in the selected project"...<br /><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/_tF6XjsUy87k/SdxJcZpuv9I/AAAAAAAACMk/RyRSxIyY8j4/s1600-h/NewUnitTestCaseFailure.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://2.bp.blogspot.com/_tF6XjsUy87k/SdxJcZpuv9I/AAAAAAAACMk/RyRSxIyY8j4/s400/NewUnitTestCaseFailure.png" /></a></div>&nbsp;...when creating a new unit test case.<br />After you have done this, you should now see your folder<br /><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/_tF6XjsUy87k/SdxI1pabTxI/AAAAAAAACMc/NdrVCfX0xGY/s1600-h/LifePinNetBeans.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://4.bp.blogspot.com/_tF6XjsUy87k/SdxI1pabTxI/AAAAAAAACMc/NdrVCfX0xGY/s320/LifePinNetBeans.png" /></a></div><br />The next step, if you didn't do yet, is to download the JUnit library. You can get it from <a href="http://www.junit.org/">here</a>. Once downloaded, place it into the "unitTests/lib" folder.<br /><br /><span style="font-size: large;">Configuring Netbeans for unit tests</span><br />Let's switch to the real stuff now, the configuration of your Netbeans IDE and your Ant build file. Before starting I strongly recommend you to backup your project. The best is if you zip your entire project folder s.t. you can quickly restore it if something went wrong.<br /><br />The first thing to do is to <b>modify the original build file</b> created by the Liferay portlet to handle the compilation and deploying of our unit tests as well as the copying of the compiled source files of our project into the unit test output folder ("unitTests/output").<br />If you created your portlet by using the Liferay-SDK's create scripts, you should have a very simple build.xml file:<br /><pre class="prettyprint">&lt;project name="portlet" basedir="." default="deploy"&gt;<br />    &lt;import file="../build-common-portlet.xml" /&gt;<br />&lt;/project&gt;</pre><br />In order to avoid typing always the same path names - which also adds bad redundancy - let's add some properties to the build.xml that reflect our project structure:<br /><pre class="prettyprint">&lt;project name="portlet" basedir="." default="deploy"&gt;<br />    &lt;import file="../build-common-portlet.xml" /&gt;<br /><br />    &lt;property name="src.dir" value="${basedir}/docroot/WEB-INF/src"/&gt;<br />    &lt;property name="classes.dir" value="${basedir}/docroot/WEB-INF/classes"/&gt;<br />    &lt;property name="lib.dir" value="${basedir}/docroot/WEB-INF/lib"/&gt;<br /><br />    &lt;property name="test.src.dir" value="${basedir}/unitTests/src"/&gt;<br />    &lt;property name="test.classes.dir" value="${basedir}/unitTests/output"/&gt;<br />    &lt;property name="test.lib.dir" value="${basedir}/unitTests/lib"/&gt;<br /><br />&lt;/project&gt;</pre><br />Next we have to add the proper Ant targets for compiling our tests, for cleaning them and another Ant "path" element for identifying the unitTest's classpath. So at the end, the final build.xml should look as follows:<br /><pre class="prettyprint">&lt;project name="portlet" basedir="." default="deploy"&gt;<br />    &lt;import file="../build-common-portlet.xml" /&gt;<br /><br />    &lt;property name="src.dir" value="${basedir}/docroot/WEB-INF/src"/&gt;<br />    &lt;property name="classes.dir" value="${basedir}/docroot/WEB-INF/classes"/&gt;<br />    &lt;property name="lib.dir" value="${basedir}/docroot/WEB-INF/lib"/&gt;<br /><br />    &lt;property name="test.src.dir" value="${basedir}/unitTests/src"/&gt;<br />    &lt;property name="test.classes.dir" value="${basedir}/unitTests/output"/&gt;<br />    &lt;property name="test.lib.dir" value="${basedir}/unitTests/lib"/&gt;<br /><br />    &lt;target name="compile-tests" depends="compile, clean-tests"&gt;<br />        &lt;mkdir dir="${test.classes.dir}"/&gt;<br />        &lt;javac classpathref="test.class.path"<br />                destdir="${test.classes.dir}"<br />                srcdir="${test.src.dir}"<br />                debug="true"<br />                target="${ant.build.javac.target}"&gt;<br />            &lt;include name="**/*"/&gt;<br />        &lt;/javac&gt;<br />        <br />        &lt;!-- <br />            compiled src files into the testing output directory since our tests will of course<br />            reference them<br />        --&gt;<br />        &lt;copy todir="${test.classes.dir}"&gt;<br />            &lt;fileset dir="${classes.dir}"/&gt;<br />        &lt;/copy&gt;<br />    &lt;/target&gt;<br /><br />    &lt;target name="clean-tests"&gt;<br />        &lt;delete dir="${test.classes.dir}"/&gt;<br />    &lt;/target&gt;<br /><br />    &lt;path id="test.class.path"&gt;<br />        &lt;pathelement location="${classes.dir}"/&gt;<br />        &lt;fileset dir="${lib.dir}"&gt;<br />            &lt;include name="*.jar"/&gt;<br />        &lt;/fileset&gt;<br />        &lt;pathelement location="${test.classes.dir}"/&gt;<br />        &lt;fileset dir="${test.lib.dir}"&gt;<br />            &lt;include name="*.jar"/&gt;<br />        &lt;/fileset&gt;<br />    &lt;/path&gt;<br />&lt;/project&gt;</pre><br />The only probably not immediately obvious task is the "compile-tests" task. So what does it do? It basically first creates the output folder "unitTests/output" where the compiled unit tests will be placed. Then it uses the "javac" task to compile all of the unit tests. Finally it also copies the compiled source files of our project to the unitTest's output folder (note: the "compile-tests" depends on "compile", so it will be guaranteed that the source files will be compiled properly).<br /><br />Unfortunately we're not yet finished. The next thing is to <b>adapt the Netbeans project.xml</b> file. You may want to make another backup of your project folder to not loose the steps till here.<br />What we want to reach now is to be able to select a unit test case in the Netbean's project view, right-click on it and run it ("Run file" or "Shift+F6). To enable this a file called "ide-file-targets.xml" has to be created in the folder "nbproject", just beside the project.xml, with the following content:<br /><pre class="prettyprint">&lt;?xml version="1.0" encoding="UTF-8"?&gt;<br />&lt;project basedir=".." name="LifePin-IDE"&gt;<br />    &lt;import file="../build.xml"/&gt;<br /><br />    &lt;!-- runs the selected file in the unitTest source folder as JUnit test --&gt;<br />    &lt;target name="run-selected-file-in-unitTests"&gt;<br />        &lt;fail unless="run.class"&gt;Must set property 'run.class'&lt;/fail&gt;<br />        &lt;mkdir dir="${test.classes.dir}"/&gt;<br />        &lt;junit dir="${test.classes.dir}" fork="true" printsummary="true" showoutput="true"&gt;<br />            &lt;classpath refid="test.class.path"/&gt;<br />            &lt;formatter type="brief" usefile="false"/&gt;<br />            &lt;formatter type="xml"/&gt;<br />            &lt;test name="${run.class}"/&gt;<br />        &lt;/junit&gt;<br />    &lt;/target&gt;<br /><br />&lt;/project&gt;<br /></pre><br />Then switch to the project.xml and exchange the "ide-actions" with the following:<br /><pre class="prettyprint">&lt;ide-actions&gt;<br />    &lt;action name="build"&gt;<br />        &lt;target&gt;compile&lt;/target&gt;<br />        &lt;target&gt;compile-tests&lt;/target&gt;<br />    &lt;/action&gt;<br />    &lt;action name="clean"&gt;<br />        &lt;target&gt;clean&lt;/target&gt;<br />        &lt;target&gt;clean-tests&lt;/target&gt;<br />    &lt;/action&gt;<br />    &lt;action name="rebuild"&gt;<br />        &lt;target&gt;clean&lt;/target&gt;<br />        &lt;target&gt;compile&lt;/target&gt;<br />    &lt;/action&gt;<br />    &lt;action name="run.single"&gt;<br />        &lt;script&gt;nbproject/ide-file-targets.xml&lt;/script&gt;<br />        &lt;target&gt;run-selected-file-in-unitTests&lt;/target&gt;<br />        &lt;context&gt;<br />            &lt;property&gt;run.class&lt;/property&gt;<br />            &lt;folder&gt;unitTests/src&lt;/folder&gt;<br />            &lt;pattern&gt;\.java$&lt;/pattern&gt;<br />            &lt;format&gt;java-name&lt;/format&gt;<br />            &lt;arity&gt;<br />                &lt;one-file-only/&gt;<br />            &lt;/arity&gt;<br />        &lt;/context&gt;<br />    &lt;/action&gt;<br />    &lt;action name="debug.single"&gt;<br />        &lt;script&gt;nbproject/ide-file-targets.xml&lt;/script&gt;<br />        &lt;target&gt;debug-selected-file-in-unitTests&lt;/target&gt;<br />        &lt;context&gt;<br />            &lt;property&gt;debug.class&lt;/property&gt;<br />            &lt;folder&gt;unitTests/src&lt;/folder&gt;<br />            &lt;pattern&gt;\.java$&lt;/pattern&gt;<br />            &lt;format&gt;java-name&lt;/format&gt;<br />            &lt;arity&gt;<br />                &lt;one-file-only/&gt;<br />            &lt;/arity&gt;<br />        &lt;/context&gt;<br />    &lt;/action&gt;<br />&lt;/ide-actions&gt;</pre><br />Now as a last step we have to configure Netbeans to be able to build correctly. This has nothing to do with your build scripts, but just that Netbeans correctly recognizes the different source files and compiles when you type the code in the editor. Go to the project properties and reference your needed libraries as shown in the screenshot below (of course you'll have different jars). Note: save your project.xml before, since it will be modified by Netbeans when you change the settings here.<br /><br /><div class="separator" style="clear: both; text-align: center;"></div><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/_tF6XjsUy87k/Sd3JxPPwa2I/AAAAAAAACM0/tqmH-79tsPk/s1600-h/unitTestsClasspath.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://4.bp.blogspot.com/_tF6XjsUy87k/Sd3JxPPwa2I/AAAAAAAACM0/tqmH-79tsPk/s400/unitTestsClasspath.png" /></a></div><br />Oh, I forgot one thing: test debugging :) . That's really essential 'cause when a test fails you want to debug it and step through the code in order to find the root of your trouble. To do so there are two important steps to follow. First add the following target to your "ide-file-targets.xml":<br /><pre class="prettyprint">&lt;target name="debug-selected-file-in-unitTests"&gt;<br />    &lt;fail unless="debug.class"&gt;Must set property 'debug.class'&lt;/fail&gt;<br />    &lt;nbjpdastart addressproperty="jpda.address" name="LifePin" transport="dt_socket"&gt;<br />        &lt;classpath refid="test.class.path"/&gt;<br />    &lt;/nbjpdastart&gt;<br />     &lt;junit dir="${test.classes.dir}" fork="true" printsummary="true" showoutput="true"&gt;<br />        &lt;classpath refid="test.class.path"/&gt;<br />        &lt;jvmarg value="-Xdebug"/&gt;<br />        &lt;jvmarg value="-Xrunjdwp:transport=dt_socket,address=${jpda.address}"/&gt;<br />        &lt;formatter type="brief" usefile="false"/&gt;<br />        &lt;formatter type="xml"/&gt;<br />        &lt;test name="${debug.class}"/&gt;<br />    &lt;/junit&gt;<br />&lt;/target&gt;</pre><br />Then you have to correctly configure the output path of your unitTests test folder, otherwise the compiler will not stop:<br /><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/_tF6XjsUy87k/Sd5dPcbvm-I/AAAAAAAACNM/JltKeO909Ok/s1600-h/ouputPath.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://1.bp.blogspot.com/_tF6XjsUy87k/Sd5dPcbvm-I/AAAAAAAACNM/JltKeO909Ok/s400/ouputPath.png" /></a></div><br /><br /><span style="font-size: large;">Coding a test, creating a test suite</span><br />You should now be ready to write your first unit test and run it. For convenience reasons I always usually create a test suite which groups the different test cases. Here's an example for JUnit 4:<br /><pre class="prettyprint">@RunWith(Suite.class)<br />@Suite.SuiteClasses({AnotherTest.class, PinboardServiceTest.class})<br />public class TestSuiteAll {<br /><br />    @BeforeClass<br />    public static void setUpClass() throws Exception {<br />    }<br /><br />    @AfterClass<br />    public static void tearDownClass() throws Exception {<br />    }<br /><br />    @Before<br />    public void setUp() throws Exception {<br />    }<br /><br />    @After<br />    public void tearDown() throws Exception {<br />    }<br /><br />}</pre><br />You should get something like this:<br /><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/_tF6XjsUy87k/Sd5ViUURoOI/AAAAAAAACM8/EwuIu8nnS5U/s1600-h/testOutput.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://3.bp.blogspot.com/_tF6XjsUy87k/Sd5ViUURoOI/AAAAAAAACM8/EwuIu8nnS5U/s400/testOutput.png" /></a>&nbsp;</div><div class="separator" style="clear: both; text-align: left;"></div><div class="separator" style="clear: both; text-align: left;">So that concludes this tutorial. I hope I was able to help someone. Feel free to leave any comment if you have problems. </div>