---
layout: post
title: "Android Instrumentation test - AndroidTestCase: java.lang.IllegalAccessError"
date: 2010-06-06
comments: true
tags: [  Eclipse, mobile dev, Android, testing ]
---

Today I started writing the instrumentation tests for the Android platform side of the project. For your understanding, here's the structure of my situation:<br /><ul><li><u>Library Project</u><br />This part of the project encapsulates general functionality and functions as platform independent class library allowing to plug-in the platform dependent components. Testing is straightforward and can be done with plain-old jUnit tests.<br /><br /></li><li><u>Android Project</u><br />This is the part of the project which is being deployed on the Android OS platform. It uses the previously mentioned "Library Project" which is directly referenced in the Eclipse workspace.<br /><br /></li><li><u>Android Test Project</u><br />This project contains all of the Android platform specific instrumentation tests.</li></ul><div>So far everything's good. In the Android Test Project I'm writing my test cases extending from the AndroidTestCase class which gives me basic Android-platform specific objects like the Context object. The Android Test Project references the Android Project for testing it, obviously :) . Moreover since&nbsp;in the test cases I'm using objects from the Library Project I've referenced also this one.</div><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/_tF6XjsUy87k/TAgNJ3zYbFI/AAAAAAAACl4/GEFM7TTR36A/s1600/InstrumentationTestProjReferences.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;" rel="zoombox"><img border="0" height="292" src="http://4.bp.blogspot.com/_tF6XjsUy87k/TAgNJ3zYbFI/AAAAAAAACl4/GEFM7TTR36A/s400/InstrumentationTestProjReferences.png" width="400" /></a></div><div><br /></div><div>For the purpose of comfortableness you create a generic suite like the following<br /><pre class="prettyprint">public class AllInstrumentationTests extends TestSuite {<br /><br /> public static Test suite(){<br />  return new TestSuiteBuilder(AllInstrumentationTests.class)<br />   .includeAllPackagesUnderHere()<br />   .build();<br /> }<br />}</pre>Then running this test using the correct menu entry "Android JUnit Test"...<br /><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/_tF6XjsUy87k/TAgORXfpKaI/AAAAAAAACl8/b4lWLICQHDE/s1600/AndroidTestCase.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="112" src="http://1.bp.blogspot.com/_tF6XjsUy87k/TAgORXfpKaI/AAAAAAAACl8/b4lWLICQHDE/s320/AndroidTestCase.png" width="320" /></a></div><br />...gave the error<br /><pre class="code">[2010-06-03 21:45:04 - DroidSenseInstrumentationTests] Launching instrumentation android.test.InstrumentationTestRunner on device emulator-5554<br />[2010-06-03 21:45:10 - DroidSenseInstrumentationTests] Test run failed: java.lang.IllegalAccessError<br />[2010-06-03 21:45:10 - DroidSenseInstrumentationTests] Test run complete<br /></pre></div><div>...with the more "concrete" message<br /><blockquote>java.lang.IllegalAccessError: Class ref in pre-verified class resolved to unexpected implementation</blockquote>Beside the Eclipse jUnit runner which seems to have problem with the instrumentation tests, forcing me to often start them multiple times in order to get a result (hate that!!), it drove me crazy in trying to find the problem for it. I soon discovered it must depend on the included Library Project.&nbsp;<a href="http://dtmilano.blogspot.com/2009/12/android-testing-external-libraries.html">This blog post</a>&nbsp;then pointed me to the right direction and finally I solved the problem.<br /><br />The Library Project shouldn't be included on the Android Test Project's build path, but instead you need to <b>export</b>&nbsp;(check it in the "Order and Export" tab)&nbsp;it from the Android Project. Otherwise your Android Test Project won't compile:<br /><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/_tF6XjsUy87k/TAgQrKV0cDI/AAAAAAAACmA/K5dhs0mGEvE/s1600/MainDroidProjExport.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="292" src="http://4.bp.blogspot.com/_tF6XjsUy87k/TAgQrKV0cDI/AAAAAAAACmA/K5dhs0mGEvE/s400/MainDroidProjExport.png" width="400" /></a></div>The same holds for externally included libraries.<br /><ul><li>Reference the library in the build path of your <i>main</i>&nbsp;project as usual, but also check it to be <i>exported</i></li><li>In the test project <i>just</i>&nbsp;reference your main project which is subject to the tests. You will <i>not</i>&nbsp;need to also include the externally used library</li></ul><div>Now everything should run "smoothly" (under quotation marks 'cause the Android jUnit integration in Eclipse is everything else than "smooth" right now).<br /><br />Btw, running the tests from the shell rather than from within Eclipse runs them faster, however, remember to deploy your app on your emulator first. The command:</div><div><pre class="code">adb shell am instrument -w com.yourcompany.youapp.test/android.test.InstrumentationTestRunner</pre></div><div><br /></div></div>