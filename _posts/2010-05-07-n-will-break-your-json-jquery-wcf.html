---
layout: post
title: "'\\n' will break your JSON jQuery - WCF service call"
date: 2010-05-07
comments: true
tags: [  JavaScript, ASP.net, Web dev, jQuery ]
---

<p>I recently coded a WCF REST webservice that needed to be accessed from JavaScript. Basically it was a system to provide admins of websites with a real-time system for managing info messages, intended to be displayed beneath input fields. jQuery came in quite handy in this context (as you may imagine ;) ).</p>

I used the standard <code>$.ajax(...)</code> function for sending/retrieving JSON encoded data to my webservice and everything wrapped up and displayed nicely within a small model popup window. That worked out quite well until some more intensive tests I made during which I discovered problems in case of multi-line text messages, i.e. within a text area. During transmission the following exception got fired:<br /><br /><pre class="code">{"ExceptionDetail":<br /> {"HelpLink":null,<br />  "InnerException":<br />  {"HelpLink":null,<br />   "InnerException":<br />   {"HelpLink":null,<br />    "InnerException":null,<br />    <b>"Message":"Encountered invalid character '\u000a'.",</b><br />    "StackTrace":"   in System.Runtime.Serialization.Json.XmlJsonReader.ComputeQuotedTextLengthUntilEndQuote(Byte[] buffer, Int32 offset, Int32 offsetMax, Boolean&amp; escaped)<br />         in System.Runtime.Serialization.Json.XmlJsonReader.ReadQuotedText(Boolean moveToText)<br />         in System.Runtime.Serialization.Json.XmlJsonReader.Read()<br />         in System.Xml.XmlBaseReader.ReadElementContentAsString()<br />         in System.Runtime.Serialization.XmlReaderDelegator.ReadElementContentAsString()<br />         in System.Runtime.Serialization.Json.JsonStringDataContract.ReadJsonValueCore(XmlReaderDelegator jsonReader, XmlObjectSerializerReadContextComplexJson context)<br />         in System.Runtime.Serialization.Json.JsonDataContract.ReadJsonValue(XmlReaderDelegator jsonReader, XmlObjectSerializerReadContextComplexJson context)<br />         in System.Runtime.Serialization.Json.DataContractJsonSerializer.InternalReadObject(XmlReaderDelegator xmlReader, Boolean verifyObjectName)<br />         in System.Runtime.Serialization.XmlObjectSerializer.ReadObjectHandleExceptions(XmlReaderDelegator reader, Boolean verifyObjectName)",<br />     "Type":"System.FormatException"},<br /> ...</pre><br />The most interesting part is the one I highlighted. The problem was clear, the newline character broke my JSON string which could then no more be deserialized on the server-side. As you can see from the transmitted data<br /><pre class="code">{"keycode": "ContractFilter_txtCNCN_Desc", "messageDe": "ddd<br /><br />d", "messageIt": "d"}</pre>it got split up into multiple lines, breaking the JSON format basically.<br /><br />The solution is at hand: these newline chars have to be encoded. One approach could be to make use of the JavaScript <code>escape(..)</code> function, but this has the drawback of polluting your transmitted string with these strange encoding chars and you would have somehow the need to again unescape it on the server side for having your data stored cleanly. Therefore a better, and probably more simple solution is to have a function like this:<br /><pre class="prettyprint">/*<br />*  Escape newline chars for being transmitted with JSON over the wire<br />*/<br />function escapeNewLineChars(valueToEscape) {<br />    if (valueToEscape != null &amp;&amp; valueToEscape != "") {<br />        return valueToEscape.replace(/\n/g, "\\n");<br />    } else {<br />        return valueToEscape;<br />    }<br />}</pre>The comment pretty much explains what it does. It basically replaces all&nbsp;occurrences&nbsp;of "\n" (newline chars) with "\\n", basically escaping them. The transmitted JSON string<br /><pre class="code">{"keycode": "ContractFilter_txtCNCN_PROT_NR", "messageDe": "ddd\n\nd", "messageIt": "d"}</pre>looks clean and moreover it can be stored on the server-side without any further interventions. Other functions which you might find quite handy...<br /><pre class="prettyprint">/*<br />*  Converts \n newline chars into &lt;br&gt; chars s.t. they are visible<br />*  inside HTML<br />*/<br />function convertToHTMLVisibleNewline(value) {<br />    if (value != null &amp;&amp; value != "") {<br />        return value.replace(/\n/g, "&lt;br/&gt;");<br />    } else {<br />        return value;<br />    }<br />}<br /><br />/*<br />*  Converts &lt;br&gt; chars into \n newline chars s.t. they are visible<br />*  inside text edit boxes<br />*/<br />function convertToTextVisibleNewLine(value) {<br />    if (value != null &amp;&amp; value != "") {<br />        return value.replace(/\&lt;br\&gt;/g, "\n");<br />    } else {<br />        return value;<br />    }<br />}</pre>