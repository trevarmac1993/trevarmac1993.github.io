---
layout: post
title: "Retrieve Selected Items on Checkable ListView: Differences in SDK Level 7 and 8"
date: 2010-09-14
comments: true
tags: [  annotated, Java, mobile dev, Android ]
---

<p>I'm currently testing my Android app that I'm developing for my MSc thesis on different real devices. While I own a Nexus One with Android Froyo 2.2 installed (SDK Level 8) I got now another device, an HTC Hero with a slightly older version, namely v2.1-update1 (Level 7).
</p>

And while doing some tests I observed an interesting behavior when working with checkable ListViews, basically those where you set the "choice mode" to <code>ListView.Choice_MODE_MULTIPLE</code>. I use this for giving the possibility to tag some items. The user gets a list of available tags on which he can select multiple ones and once he closes the activity, I collect the selected items and update the underlying data accordingly.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/_tF6XjsUy87k/TI6CJjMQZXI/AAAAAAAACxg/6_RiCKJ9u4g/s1600/tagging.png" imageanchor="1" rel="zoombox" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="185" src="http://1.bp.blogspot.com/_tF6XjsUy87k/TI6CJjMQZXI/AAAAAAAACxg/6_RiCKJ9u4g/s200/tagging.png" width="200" /></a></div><br /><br />On SDK Level 8, what you would do is to call the <code>getCheckedItemIds()</code> which returns an array of type <code>long[]</code> containing all of the ids of the selected tags.<br /><pre class="brush: java; gutter:false;">long[] selectedIds = getListView().getCheckedItemIds();<br /></pre>This is really handy since you can now just call your DB access layer and update your data with the given ids. Sadly this method is not supported on SDK level 7. So if you need to be backward compatible you better don't use this method, but instead there is apparently a similar one, <code>getCheckItemIds()</code> (I thought). However, using it resulted in strange side effects. It seemed as if not only the active items but also those which were active at startup of the dialog but which have then become inactive later due to the user's interaction. In fact, looking at the new API level 8 ListView method you'll find it to be depreciated with a comment<br /><blockquote>Old behavior was buggy, but would sort of work for adapters without stable IDs.<br />Fall back to it to support legacy apps.</blockquote>Having <b>stable</b>&nbsp;ids, it didn't work for me, so I coded the solution myself:<br /><pre class="brush:java;">private long[] getCheckedItemsIdsFix(){<br /> SparseBooleanArray checkItemPositions = getListView().getCheckedItemPositions();<br /> int checkedPositionsCount = checkItemPositions.size();<br />  <br /> long[] checkedIds = new long[checkedPositionsCount];<br /> int checkedCount = 0;<br /> for (int i = 0; i &lt; checkedPositionsCount; i++) {<br />  if(checkItemPositions.valueAt(i)){<br />   checkedIds[checkedCount++] = getListAdapter().getItemId(checkItemPositions.keyAt(i));<br />  }<br /> }<br />  <br /> //check whether the size matches, otherwise shrink the array.<br /> if(checkedCount == checkedPositionsCount)<br />  return checkedIds;<br /> else{<br />  final long[] adjustedIdsArray = new long[checkedCount];<br />  System.arraycopy(checkedIds, 0, adjustedIdsArray, 0, checkedCount);<br />   <br />  return adjustedIdsArray;<br /> }<br />}<br /></pre>