---
layout: post
title: "Detecting Location Redirects from JavaScript"
date: 2012-05-24
comments: true
tags: [  JavaScript, Web dev ]
reposts: ["http://www.dzone.com/articles/detecting-location-redirects"]
---

<p>A common scenario for using the <a href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.30" target="_blank">HTTP Location response</a> header is during an authentication process where some kind of filter redirects to a login page in case when the user is not or no more authenticated. Handling such redirects&nbsp;from JavaScript turned out to be not so simple as it might initially seem. <a href="http://stackoverflow.com/questions/199099/how-to-manage-a-redirect-request-after-a-jquery-ajax-call" target="_blank">Stackoverflow has already a post</a> on that and here (<a href="http://stackoverflow.com/a/10717647/50109" target="_blank">or on SO</a>) is how I solved it in the end.</p><br />My scenario is basically the following. I have an ISA server which intercepts all of the requests and verifies the user's authentication. In case when the user isn't logged in it <b>responds with a 302 and adds the location header</b> to my login page.<br /><h2>    The Initial Approach</h2>In the case of a rich JavaScript client you would then have something like <br /><pre class="brush:javascript">$(document).ajaxComplete(function(e, xhr, settings){<br />    if(xhr.status === 302){<br />        //check for location header and redirect...<br />    }<br />});<br /></pre>But unfortunately the browser handles location redirects completely himself, wherefore the <code>ajaxComplete</code> callback won't fire with the <code>302</code> status code, but instead it will fire on the location redirect target (when that redirect already happened successfully). As a result, the approach before obviously won't work.<br /><h2>   The Solution</h2>The solution is a bit hacky but it works and I didn't found a better one so far (comment if I'm wrong). Basically what you do is to inject a custom header in your Login page for which you then listen on your client-side. The trick is to inject a header like <br /><pre class="code">LoginPage: http://www.mydomain.com/Login<br /></pre>where the url is the one of the invoked Login page due to the location redirect.&nbsp;On the client side you can now check for the presence of the header like<br /><pre class="brush:javascript">if(xhr.status === 200){<br />    var loginPageHeader = xhr.getResponseHeader("LoginPage");<br />    if(loginPageHeader &amp;&amp; loginPageHeader !== ""){<br />        window.location.replace(loginPageHeader);<br />    }<br />}<br /></pre>You might wonder why I included the url directly in the header value. The problem is that you have no way of detecting the URL of the <strong>redirected request</strong> in the <code>ajaxComplete</code> callback. You just get the initial one you started, that is, when you execute a <code>GET /person/1</code> and you're no more logged in (because the session expired) and the server sends you a <code>302 redirect</code> to <code>/login</code>, then you'll see the <code>/person/1</code> as the url in your <code>ajaxComplete</code> callback although the content of the response is the one of your login page. That's why I directly included the url in my custom header.<br /><br />Here's my explanation on SO: <a href="http://stackoverflow.com/a/10717647/50109">http://stackoverflow.com/a/10717647/50109</a>