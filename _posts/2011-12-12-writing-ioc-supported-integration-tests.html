---
layout: post
title: "Writing IoC Supported Integration Tests using AutoFac"
date: 2011-12-12
comments: true
tags: [  Best Practices, C#, testing, .Net ]
---

<p>Using a dependency injection framework can <a href="http://blog.js-development.com/2010/12/smelly-code-direct-object-instantiation.html" target="_blank">greatly facilitate</a> your <a href="http://blog.js-development.com/2010/03/tackle-software-dependencies-with-ioc.html" target="_blank">code's testability</a>&nbsp;in that you don't have any "glue" code for managing a classes' dependency that needs to be mocked (if even possible) when writing unit tests. But what about when writing <b>integration tests</b>? In such case you'd probably want to use your IoC container's configuration for resolving types in order to also verify the proper <i>integration </i>of your components, frankly your dependency injection configuration, right?
</p>

<div class="separator" style="clear: both; text-align: center;"><a href="http://code.google.com/p/autofac/logo?cct=1304973969" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://code.google.com/p/autofac/logo?cct=1304973969" /></a></div>With AutoFac it is actually quite simple. What your integration test needs to do is to himself create the <code>ContainerBuilder()</code> and accordingly register the dependencies. What you should do is the following. Assume you have a Visual Studio project that encapsulates your business logic called "BusinessLogic". Then the best strategy is to <b>create a so-called Autofac module per project </b>(and hence dll) to configure the dependencies within that specific project. This is done by extending the abstract class <code>Autofac.Module</code> like<br /><pre class="brush:csharp">public class BusinessLogicModule : Module<br />{<br />    protected override void Load(ContainerBuilder builder)<br />    {<br />        //register other modules/dependencies here<br />    }<br />}<br /></pre><br />When you now want to write a test for the BusinessLogic project, you might create a <code>BusinessLogic.IntegrationTests</code> project, adding the project under test as a reference.<br />A possible approach to this could be the following: create ageneric class for instantiating the Autofac IoC container with the BusinessLogicModule created before. Let's call this class&nbsp;<b>"IoCSupportedTest"</b>:<br /><pre class="brush:csharp">using Autofac;<br />using Autofac.Core;<br /><br />namespace BusinessLogic.IntegrationTest.Utils<br />{<br />    public class IoCSupportedTest&lt;TModule&gt; where TModule : IModule, new()<br />    {<br />        private IContainer container;<br /><br />        public IoCSupportedTest()<br />        {<br />            var builder = new ContainerBuilder();<br /><br />            builder.RegisterModule(new TModule());<br /><br />            container = builder.Build();<br />        }<br /><br />        protected TEntity Resolve&lt;TEntity&gt;()<br />        {<br />            return container.Resolve&lt;TEntity&gt;();<br />        }<br /><br />        protected void ShutdownIoC()<br />        {<br />            container.Dispose();<br />        }<br />    }<br />}</pre>A specific test case might then look as follows:<br /><pre class="brush:csharp">[TestClass]<br />public class UserRepositoryTest : IoCSupportedTest&lt;BusinessLogicModule&gt;<br />{<br />    private IUserRepository userRepo;<br /><br />    [TestInitialize]<br />    public void Setup()<br />    {<br />        this.userRepo = Resolve&lt;IUserRepository&gt;();<br />    }<br /><br />    [TestCleanup]<br />    public void TearDown()<br />    {<br />        userRepo = null;<br />        ShutdownIoC();<br />    }<br /><br />    //the tests<br />}</pre><br />